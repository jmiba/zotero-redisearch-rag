"use strict";var U=Object.create;var b=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var V=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var M=(c,t)=>{for(var e in t)b(c,e,{get:t[e],enumerable:!0})},Z=(c,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of B(t))!E.call(c,s)&&s!==e&&b(c,s,{get:()=>t[s],enumerable:!(i=$(t,s))||i.enumerable});return c};var S=(c,t,e)=>(e=c!=null?U(V(c)):{},Z(t||!c||!c.__esModule?b(e,"default",{value:c,enumerable:!0}):e,c)),z=c=>Z(b({},"__esModule",{value:!0}),c);var L={};M(L,{default:()=>x});module.exports=z(L);var r=require("obsidian"),A=require("child_process"),I=S(require("http")),N=S(require("https")),p=S(require("path"));var h=require("obsidian"),C={zoteroBaseUrl:"http://127.0.0.1:23119/api",zoteroUserId:"0",pythonPath:"python3",outputPdfDir:"zotero/pdfs",outputItemDir:"zotero/items",outputNoteDir:"zotero/notes",outputChunkDir:"zotero/chunks",redisUrl:"redis://127.0.0.1:6379",redisIndex:"idx:zotero",redisPrefix:"zotero:chunk:",embedBaseUrl:"http://localhost:1234/v1",embedApiKey:"lm-studio",embedModel:"google/embedding-gemma-300m",chatBaseUrl:"",chatApiKey:"",chatModel:"meta-llama/llama-3.1-405b-instruct",chatTemperature:.2,ocrMode:"auto",chunkingMode:"page"},v=class extends h.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Zotero RAG Settings"}),new h.Setting(t).setName("Zotero base URL").setDesc("Local Zotero API base URL, e.g. http://127.0.0.1:23119/api").addText(e=>e.setPlaceholder("http://127.0.0.1:23119/api").setValue(this.plugin.settings.zoteroBaseUrl).onChange(async i=>{this.plugin.settings.zoteroBaseUrl=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Zotero user ID").setDesc("Use 0 for local library. You can also enter users/<id> or groups/<id>.").addText(e=>e.setPlaceholder("123456").setValue(this.plugin.settings.zoteroUserId).onChange(async i=>{this.plugin.settings.zoteroUserId=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Python path").setDesc("Path to python3").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async i=>{this.plugin.settings.pythonPath=i.trim()||"python3",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Output folders (vault-relative)"}),new h.Setting(t).setName("PDF folder").addText(e=>e.setPlaceholder("zotero/pdfs").setValue(this.plugin.settings.outputPdfDir).onChange(async i=>{this.plugin.settings.outputPdfDir=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Item JSON folder").addText(e=>e.setPlaceholder("zotero/items").setValue(this.plugin.settings.outputItemDir).onChange(async i=>{this.plugin.settings.outputItemDir=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Notes folder").addText(e=>e.setPlaceholder("zotero/notes").setValue(this.plugin.settings.outputNoteDir).onChange(async i=>{this.plugin.settings.outputNoteDir=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Chunks JSON folder").addText(e=>e.setPlaceholder("zotero/chunks").setValue(this.plugin.settings.outputChunkDir).onChange(async i=>{this.plugin.settings.outputChunkDir=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Redis Stack"}),new h.Setting(t).setName("Redis URL").addText(e=>e.setPlaceholder("redis://127.0.0.1:6379").setValue(this.plugin.settings.redisUrl).onChange(async i=>{this.plugin.settings.redisUrl=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Index name").addText(e=>e.setPlaceholder("idx:zotero").setValue(this.plugin.settings.redisIndex).onChange(async i=>{this.plugin.settings.redisIndex=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Key prefix").addText(e=>e.setPlaceholder("zotero:chunk:").setValue(this.plugin.settings.redisPrefix).onChange(async i=>{this.plugin.settings.redisPrefix=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Embeddings (LM Studio)"}),new h.Setting(t).setName("Embeddings base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.embedBaseUrl).onChange(async i=>{this.plugin.settings.embedBaseUrl=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Embeddings API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.embedApiKey).onChange(async i=>{this.plugin.settings.embedApiKey=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Embeddings model").addText(e=>e.setPlaceholder("google/embedding-gemma-300m").setValue(this.plugin.settings.embedModel).onChange(async i=>{this.plugin.settings.embedModel=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Chat LLM"}),new h.Setting(t).setName("Chat base URL").setDesc("OpenAI-compatible chat endpoint base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.chatBaseUrl).onChange(async i=>{this.plugin.settings.chatBaseUrl=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Chat API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.chatApiKey).onChange(async i=>{this.plugin.settings.chatApiKey=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Chat model").addText(e=>e.setPlaceholder("meta-llama/llama-3.1-405b-instruct").setValue(this.plugin.settings.chatModel).onChange(async i=>{this.plugin.settings.chatModel=i.trim(),await this.plugin.saveSettings()})),new h.Setting(t).setName("Temperature").addText(e=>e.setPlaceholder("0.2").setValue(String(this.plugin.settings.chatTemperature)).onChange(async i=>{let s=Number.parseFloat(i);this.plugin.settings.chatTemperature=Number.isFinite(s)?s:.2,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Docling"}),new h.Setting(t).setName("OCR mode").setDesc("auto, force, or off").addDropdown(e=>e.addOption("auto","auto").addOption("force","force").addOption("off","off").setValue(this.plugin.settings.ocrMode).onChange(async i=>{this.plugin.settings.ocrMode=i,await this.plugin.saveSettings()})),new h.Setting(t).setName("Chunking").setDesc("page or section").addDropdown(e=>e.addOption("page","page").addOption("section","section").setValue(this.plugin.settings.chunkingMode).onChange(async i=>{this.plugin.settings.chunkingMode=i,await this.plugin.saveSettings()}))}};var k=class extends r.Modal{constructor(t,e,i,s){super(t),this.titleText=e,this.placeholder=i,this.onSubmit=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.focus();let i=t.createEl("button",{text:"Submit"});i.style.marginTop="0.75rem";let s=()=>{let n=e.value.trim();if(!n){new r.Notice("Query cannot be empty.");return}this.close(),this.onSubmit(n)};i.addEventListener("click",s),e.addEventListener("keydown",n=>{n.key==="Enter"&&s()})}},D=class extends r.Modal{constructor(t,e,i){super(t),this.titleText=e,this.bodyText=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText}),t.createEl("pre").setText(this.bodyText)}},x=class extends r.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new v(this.app,this)),this.addCommand({id:"import-zotero-item-index",name:"Import Zotero item and index (Docling -> RedisSearch)",callback:()=>this.importZoteroItem()}),this.addCommand({id:"ask-zotero-library",name:"Ask my Zotero library (RAG via RedisSearch)",callback:()=>this.askZoteroLibrary()})}async loadSettings(){this.settings=Object.assign({},C,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async importZoteroItem(){var y,w;let t=this.getZoteroBridgeApi();if(!t){new r.Notice("Zotero Bridge API not found. Ensure the Zotero Bridge plugin is installed.");return}let e;try{let a=await t.search();e=this.pickZoteroItem(a)}catch(a){new r.Notice("Zotero search failed. See console for details."),console.error(a);return}if(!e){new r.Notice("No Zotero item selected.");return}let i;try{i=(w=await((y=e.getValues)==null?void 0:y.call(e)))!=null?w:e}catch(a){new r.Notice("Failed to read Zotero item values."),console.error(a);return}let s=this.getDocId(i);if(!s){new r.Notice("Could not resolve a stable doc_id from Zotero item.");return}let n=await this.resolvePdfAttachmentKey(i,s);if(!n){new r.Notice("No PDF attachment found for item.");return}let u=(0,r.normalizePath)(`${this.settings.outputPdfDir}/${s}.pdf`),o=(0,r.normalizePath)(`${this.settings.outputItemDir}/${s}.json`),l=(0,r.normalizePath)(`${this.settings.outputChunkDir}/${s}.json`),d=(0,r.normalizePath)(`${this.settings.outputNoteDir}/${s}.md`);try{await this.ensureFolder(this.settings.outputPdfDir),await this.ensureFolder(this.settings.outputItemDir),await this.ensureFolder(this.settings.outputChunkDir),await this.ensureFolder(this.settings.outputNoteDir)}catch(a){new r.Notice("Failed to create output folders."),console.error(a);return}try{let a=await this.downloadZoteroPdf(n);await this.app.vault.adapter.writeBinary(u,a)}catch(a){new r.Notice("Failed to download PDF attachment."),console.error(a);return}try{await this.app.vault.adapter.write(o,JSON.stringify(i,null,2))}catch(a){new r.Notice("Failed to write Zotero item JSON."),console.error(a);return}let m=this.getPluginDir(),f=p.default.join(m,"tools","docling_extract.py"),g=p.default.join(m,"tools","index_redisearch.py");try{await this.runPython(f,["--pdf",this.getAbsoluteVaultPath(u),"--doc-id",s,"--out-json",this.getAbsoluteVaultPath(l),"--out-md",this.getAbsoluteVaultPath(d),"--chunking",this.settings.chunkingMode,"--ocr",this.settings.ocrMode])}catch(a){new r.Notice("Docling extraction failed. See console for details."),console.error(a);return}try{await this.runPython(g,["--chunks-json",this.getAbsoluteVaultPath(l),"--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel])}catch(a){new r.Notice("RedisSearch indexing failed. See console for details."),console.error(a);return}try{let a=await this.app.vault.adapter.read(d),P=this.buildNoteMarkdown(i,s,u,o,a);await this.app.vault.adapter.write(d,P)}catch(a){new r.Notice("Failed to finalize note markdown."),console.error(a);return}new r.Notice(`Indexed Zotero item ${s}.`)}async askZoteroLibrary(){if(!this.settings.chatBaseUrl){new r.Notice("Chat base URL must be set in settings.");return}new k(this.app,"Ask Zotero Library","Enter your query",async t=>{var m,f;let e=this.getPluginDir(),i=p.default.join(e,"tools","rag_query_redisearch.py"),s="";try{s=await this.runPythonWithOutput(i,["--query",t,"--k","5","--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel,"--chat-base-url",this.settings.chatBaseUrl,"--chat-api-key",this.settings.chatApiKey,"--chat-model",this.settings.chatModel,"--temperature",String(this.settings.chatTemperature)])}catch(g){new r.Notice("RAG query failed. See console for details."),console.error(g);return}let n;try{n=JSON.parse(s)}catch(g){new r.Notice("Failed to parse RAG response."),console.error(g);return}let u=(m=n==null?void 0:n.answer)!=null?m:"",l=((f=n==null?void 0:n.citations)!=null?f:[]).map(g=>{var w,a,P,T;let y=(P=g.pages)!=null?P:`${(w=g.page_start)!=null?w:"?"}-${(a=g.page_end)!=null?a:"?"}`;return`${(T=g.doc_id)!=null?T:"?"} pages ${y}`}).join(`
`),d=`${u}

Citations:
${l||"(none)"}`;new D(this.app,"Zotero RAG Answer",d).open()}).open()}getZoteroBridgeApi(){var e,i,s;let t=(s=(i=(e=window==null?void 0:window.PluginApi)==null?void 0:e.ZoteroBridge)==null?void 0:i.v1)==null?void 0:s.call(i);return!t||typeof t.search!="function"?null:t}pickZoteroItem(t){var e;return t?Array.isArray(t)?(e=t[0])!=null?e:null:t.item?t.item:t:null}getDocId(t){let e=[t.key,t.itemKey,t.id,t.citationKey];for(let i of e)if(typeof i=="string"&&i.trim())return i.trim();return null}async resolvePdfAttachmentKey(t,e){var s,n,u;let i=this.pickPdfAttachmentKey(t);if(i)return i;try{let l=(await this.fetchZoteroChildren(e)).find(d=>{var m,f,g;return this.isPdfAttachment((g=(m=d==null?void 0:d.data)==null?void 0:m.contentType)!=null?g:(f=d==null?void 0:d.data)==null?void 0:f.mimeType)});if(l)return(u=(n=l.key)!=null?n:(s=l.data)==null?void 0:s.key)!=null?u:null}catch(o){console.error("Failed to fetch Zotero children",o)}return null}pickPdfAttachmentKey(t){var i,s,n,u,o,l,d,m,f,g;let e=(n=(s=(i=t.attachments)!=null?i:t.children)!=null?s:t.items)!=null?n:[];if(!Array.isArray(e))return null;for(let y of e){let w=(l=(u=y.contentType)!=null?u:y.mimeType)!=null?l:(o=y.data)==null?void 0:o.contentType;if(this.isPdfAttachment(w))return(g=(f=(d=y.key)!=null?d:y.attachmentKey)!=null?f:(m=y.data)==null?void 0:m.key)!=null?g:null}return null}isPdfAttachment(t){return t==="application/pdf"}async fetchZoteroChildren(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/children`),i=await this.requestLocalApi(e);return JSON.parse(i.toString("utf8"))}async downloadZoteroPdf(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/file`),i=await this.requestLocalApi(e);return i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength)}buildZoteroUrl(t){return`${this.settings.zoteroBaseUrl.replace(/\/$/,"")}${t}`}requestLocalApi(t){return new Promise((e,i)=>{let s=new URL(t),u=(s.protocol==="https:"?N.default:I.default).request({method:"GET",hostname:s.hostname,port:s.port||void 0,path:`${s.pathname}${s.search}`,headers:{Accept:"*/*"}},o=>{let l=[];o.on("data",d=>l.push(Buffer.from(d))),o.on("end",()=>{let d=Buffer.concat(l);if(o.statusCode&&o.statusCode>=400){i(new Error(`Request failed, status ${o.statusCode}: ${d.toString("utf8")}`));return}e(d)})});u.on("error",i),u.end()})}getZoteroLibraryPath(){let t=(this.settings.zoteroUserId||"0").trim();return!t||t==="0"?"users/0":t.startsWith("users/")||t.startsWith("groups/")?t:`users/${t}`}async ensureFolder(t){let e=this.app.vault.adapter,i=(0,r.normalizePath)(t).split("/").filter(Boolean),s="";for(let n of i)s=s?`${s}/${n}`:n,await e.exists(s)||await e.mkdir(s)}buildNoteMarkdown(t,e,i,s,n){let o=(typeof t.title=="string"?t.title:"").replace(/"/g,"'"),l=`[[${i}]]`,d=`[[${s}]]`;return`---
doc_id: "${e}"
title: "${o}"
---

PDF: ${l}

Item JSON: ${d}

${n}`}getVaultBasePath(){var i;let t=this.app.vault.adapter;if(t instanceof r.FileSystemAdapter)return t.getBasePath();let e=(i=t.getBasePath)==null?void 0:i.call(t);if(e)return e;throw new Error("Vault base path is unavailable.")}getPluginDir(){var s;let t=this.getVaultBasePath(),e=(s=this.manifest.dir)!=null?s:this.manifest.id;if(!e)throw new Error("Plugin directory is unavailable.");let i=p.default.isAbsolute(e)?e:p.default.join(t,e);return p.default.normalize(i)}getAbsoluteVaultPath(t){let e=this.getVaultBasePath(),i=p.default.isAbsolute(t)?t:p.default.join(e,t);return p.default.normalize(i)}runPython(t,e){return new Promise((i,s)=>{let n=(0,A.spawn)(this.settings.pythonPath,[t,...e],{cwd:p.default.dirname(t)}),u="";n.stderr.on("data",o=>{u+=o.toString()}),n.on("close",o=>{o===0?i():s(new Error(u||`Process exited with code ${o}`))})})}runPythonWithOutput(t,e){return new Promise((i,s)=>{let n=(0,A.spawn)(this.settings.pythonPath,[t,...e],{cwd:p.default.dirname(t)}),u="",o="";n.stdout.on("data",l=>{u+=l.toString()}),n.stderr.on("data",l=>{o+=l.toString()}),n.on("close",l=>{l===0?i(u.trim()):s(new Error(o||`Process exited with code ${l}`))})})}};
