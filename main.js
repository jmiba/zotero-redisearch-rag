"use strict";var Z=Object.create;var b=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var C=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var V=(h,t)=>{for(var e in t)b(h,e,{get:t[e],enumerable:!0})},D=(h,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of C(t))!z.call(h,s)&&s!==e&&b(h,s,{get:()=>t[s],enumerable:!(i=U(t,s))||i.enumerable});return h};var B=(h,t,e)=>(e=h!=null?Z(N(h)):{},D(t||!h||!h.__esModule?b(e,"default",{value:h,enumerable:!0}):e,h)),E=h=>D(b({},"__esModule",{value:!0}),h);var $={};V($,{default:()=>x});module.exports=E($);var n=require("obsidian"),S=require("child_process"),f=B(require("path"));var a=require("obsidian"),I={zoteroBaseUrl:"http://127.0.0.1:23119/api",zoteroUserId:"",zoteroApiKey:"",pythonPath:"python3",outputPdfDir:"zotero/pdfs",outputItemDir:"zotero/items",outputNoteDir:"zotero/notes",outputChunkDir:"zotero/chunks",redisUrl:"redis://127.0.0.1:6379",redisIndex:"idx:zotero",redisPrefix:"zotero:chunk:",embedBaseUrl:"http://localhost:1234/v1",embedApiKey:"lm-studio",embedModel:"google/embedding-gemma-300m",chatBaseUrl:"",chatApiKey:"",chatModel:"meta-llama/llama-3.1-405b-instruct",chatTemperature:.2,ocrMode:"auto",chunkingMode:"page"},v=class extends a.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Zotero RAG Settings"}),new a.Setting(t).setName("Zotero base URL").setDesc("Local Zotero API base URL, e.g. http://127.0.0.1:23119/api").addText(e=>e.setPlaceholder("http://127.0.0.1:23119/api").setValue(this.plugin.settings.zoteroBaseUrl).onChange(async i=>{this.plugin.settings.zoteroBaseUrl=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Zotero user ID").setDesc("Required for Zotero local API downloads").addText(e=>e.setPlaceholder("123456").setValue(this.plugin.settings.zoteroUserId).onChange(async i=>{this.plugin.settings.zoteroUserId=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Zotero API key").setDesc("Optional for local API").addText(e=>e.setPlaceholder("optional").setValue(this.plugin.settings.zoteroApiKey).onChange(async i=>{this.plugin.settings.zoteroApiKey=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Python path").setDesc("Path to python3").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async i=>{this.plugin.settings.pythonPath=i.trim()||"python3",await this.plugin.saveSettings()})),t.createEl("h3",{text:"Output folders (vault-relative)"}),new a.Setting(t).setName("PDF folder").addText(e=>e.setPlaceholder("zotero/pdfs").setValue(this.plugin.settings.outputPdfDir).onChange(async i=>{this.plugin.settings.outputPdfDir=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Item JSON folder").addText(e=>e.setPlaceholder("zotero/items").setValue(this.plugin.settings.outputItemDir).onChange(async i=>{this.plugin.settings.outputItemDir=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Notes folder").addText(e=>e.setPlaceholder("zotero/notes").setValue(this.plugin.settings.outputNoteDir).onChange(async i=>{this.plugin.settings.outputNoteDir=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Chunks JSON folder").addText(e=>e.setPlaceholder("zotero/chunks").setValue(this.plugin.settings.outputChunkDir).onChange(async i=>{this.plugin.settings.outputChunkDir=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Redis Stack"}),new a.Setting(t).setName("Redis URL").addText(e=>e.setPlaceholder("redis://127.0.0.1:6379").setValue(this.plugin.settings.redisUrl).onChange(async i=>{this.plugin.settings.redisUrl=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Index name").addText(e=>e.setPlaceholder("idx:zotero").setValue(this.plugin.settings.redisIndex).onChange(async i=>{this.plugin.settings.redisIndex=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Key prefix").addText(e=>e.setPlaceholder("zotero:chunk:").setValue(this.plugin.settings.redisPrefix).onChange(async i=>{this.plugin.settings.redisPrefix=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Embeddings (LM Studio)"}),new a.Setting(t).setName("Embeddings base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.embedBaseUrl).onChange(async i=>{this.plugin.settings.embedBaseUrl=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Embeddings API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.embedApiKey).onChange(async i=>{this.plugin.settings.embedApiKey=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Embeddings model").addText(e=>e.setPlaceholder("google/embedding-gemma-300m").setValue(this.plugin.settings.embedModel).onChange(async i=>{this.plugin.settings.embedModel=i.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Chat LLM"}),new a.Setting(t).setName("Chat base URL").setDesc("OpenAI-compatible chat endpoint base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.chatBaseUrl).onChange(async i=>{this.plugin.settings.chatBaseUrl=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Chat API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.chatApiKey).onChange(async i=>{this.plugin.settings.chatApiKey=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Chat model").addText(e=>e.setPlaceholder("meta-llama/llama-3.1-405b-instruct").setValue(this.plugin.settings.chatModel).onChange(async i=>{this.plugin.settings.chatModel=i.trim(),await this.plugin.saveSettings()})),new a.Setting(t).setName("Temperature").addText(e=>e.setPlaceholder("0.2").setValue(String(this.plugin.settings.chatTemperature)).onChange(async i=>{let s=Number.parseFloat(i);this.plugin.settings.chatTemperature=Number.isFinite(s)?s:.2,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Docling"}),new a.Setting(t).setName("OCR mode").setDesc("auto, force, or off").addDropdown(e=>e.addOption("auto","auto").addOption("force","force").addOption("off","off").setValue(this.plugin.settings.ocrMode).onChange(async i=>{this.plugin.settings.ocrMode=i,await this.plugin.saveSettings()})),new a.Setting(t).setName("Chunking").setDesc("page or section").addDropdown(e=>e.addOption("page","page").addOption("section","section").setValue(this.plugin.settings.chunkingMode).onChange(async i=>{this.plugin.settings.chunkingMode=i,await this.plugin.saveSettings()}))}};var A=class extends n.Modal{constructor(t,e,i,s){super(t),this.titleText=e,this.placeholder=i,this.onSubmit=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.focus();let i=t.createEl("button",{text:"Submit"});i.style.marginTop="0.75rem";let s=()=>{let r=e.value.trim();if(!r){new n.Notice("Query cannot be empty.");return}this.close(),this.onSubmit(r)};i.addEventListener("click",s),e.addEventListener("keydown",r=>{r.key==="Enter"&&s()})}},k=class extends n.Modal{constructor(t,e,i){super(t),this.titleText=e,this.bodyText=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText}),t.createEl("pre").setText(this.bodyText)}},x=class extends n.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new v(this.app,this)),this.addCommand({id:"import-zotero-item-index",name:"Import Zotero item and index (Docling -> RedisSearch)",callback:()=>this.importZoteroItem()}),this.addCommand({id:"ask-zotero-library",name:"Ask my Zotero library (RAG via RedisSearch)",callback:()=>this.askZoteroLibrary()})}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async importZoteroItem(){var m,w;let t=this.getZoteroBridgeApi();if(!t){new n.Notice("Zotero Bridge API not found. Ensure the Zotero Bridge plugin is installed.");return}if(!this.settings.zoteroUserId){new n.Notice("Zotero user ID is required in settings.");return}let e;try{let o=await t.search();e=this.pickZoteroItem(o)}catch(o){new n.Notice("Zotero search failed. See console for details."),console.error(o);return}if(!e){new n.Notice("No Zotero item selected.");return}let i;try{i=(w=await((m=e.getValues)==null?void 0:m.call(e)))!=null?w:e}catch(o){new n.Notice("Failed to read Zotero item values."),console.error(o);return}let s=this.getDocId(i);if(!s){new n.Notice("Could not resolve a stable doc_id from Zotero item.");return}let r=await this.resolvePdfAttachmentKey(i,s);if(!r){new n.Notice("No PDF attachment found for item.");return}let u=(0,n.normalizePath)(`${this.settings.outputPdfDir}/${s}.pdf`),d=(0,n.normalizePath)(`${this.settings.outputItemDir}/${s}.json`),l=(0,n.normalizePath)(`${this.settings.outputChunkDir}/${s}.json`),g=(0,n.normalizePath)(`${this.settings.outputNoteDir}/${s}.md`);try{await this.ensureFolder(this.settings.outputPdfDir),await this.ensureFolder(this.settings.outputItemDir),await this.ensureFolder(this.settings.outputChunkDir),await this.ensureFolder(this.settings.outputNoteDir)}catch(o){new n.Notice("Failed to create output folders."),console.error(o);return}try{let o=await this.downloadZoteroPdf(r);await this.app.vault.adapter.writeBinary(u,o)}catch(o){new n.Notice("Failed to download PDF attachment."),console.error(o);return}try{await this.app.vault.adapter.write(d,JSON.stringify(i,null,2))}catch(o){new n.Notice("Failed to write Zotero item JSON."),console.error(o);return}let p=this.getPluginDir(),y=f.default.join(p,"tools","docling_extract.py"),c=f.default.join(p,"tools","index_redisearch.py");try{await this.runPython(y,["--pdf",this.getAbsoluteVaultPath(u),"--doc-id",s,"--out-json",this.getAbsoluteVaultPath(l),"--out-md",this.getAbsoluteVaultPath(g),"--chunking",this.settings.chunkingMode,"--ocr",this.settings.ocrMode])}catch(o){new n.Notice("Docling extraction failed. See console for details."),console.error(o);return}try{await this.runPython(c,["--chunks-json",this.getAbsoluteVaultPath(l),"--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel])}catch(o){new n.Notice("RedisSearch indexing failed. See console for details."),console.error(o);return}try{let o=await this.app.vault.adapter.read(g),P=this.buildNoteMarkdown(i,s,u,d,o);await this.app.vault.adapter.write(g,P)}catch(o){new n.Notice("Failed to finalize note markdown."),console.error(o);return}new n.Notice(`Indexed Zotero item ${s}.`)}async askZoteroLibrary(){if(!this.settings.chatBaseUrl){new n.Notice("Chat base URL must be set in settings.");return}new A(this.app,"Ask Zotero Library","Enter your query",async t=>{var p,y;let e=this.getPluginDir(),i=f.default.join(e,"tools","rag_query_redisearch.py"),s="";try{s=await this.runPythonWithOutput(i,["--query",t,"--k","5","--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel,"--chat-base-url",this.settings.chatBaseUrl,"--chat-api-key",this.settings.chatApiKey,"--chat-model",this.settings.chatModel,"--temperature",String(this.settings.chatTemperature)])}catch(c){new n.Notice("RAG query failed. See console for details."),console.error(c);return}let r;try{r=JSON.parse(s)}catch(c){new n.Notice("Failed to parse RAG response."),console.error(c);return}let u=(p=r==null?void 0:r.answer)!=null?p:"",l=((y=r==null?void 0:r.citations)!=null?y:[]).map(c=>{var w,o,P,T;let m=(P=c.pages)!=null?P:`${(w=c.page_start)!=null?w:"?"}-${(o=c.page_end)!=null?o:"?"}`;return`${(T=c.doc_id)!=null?T:"?"} pages ${m}`}).join(`
`),g=`${u}

Citations:
${l||"(none)"}`;new k(this.app,"Zotero RAG Answer",g).open()}).open()}getZoteroBridgeApi(){var e,i,s;let t=(s=(i=(e=window==null?void 0:window.PluginApi)==null?void 0:e.ZoteroBridge)==null?void 0:i.v1)==null?void 0:s.call(i);return!t||typeof t.search!="function"?null:t}pickZoteroItem(t){var e;return t?Array.isArray(t)?(e=t[0])!=null?e:null:t.item?t.item:t:null}getDocId(t){let e=[t.key,t.itemKey,t.id,t.citationKey];for(let i of e)if(typeof i=="string"&&i.trim())return i.trim();return null}async resolvePdfAttachmentKey(t,e){var s,r,u;let i=this.pickPdfAttachmentKey(t);if(i)return i;try{let l=(await this.fetchZoteroChildren(e)).find(g=>{var p,y,c;return this.isPdfAttachment((c=(p=g==null?void 0:g.data)==null?void 0:p.contentType)!=null?c:(y=g==null?void 0:g.data)==null?void 0:y.mimeType)});if(l)return(u=(r=l.key)!=null?r:(s=l.data)==null?void 0:s.key)!=null?u:null}catch(d){console.error("Failed to fetch Zotero children",d)}return null}pickPdfAttachmentKey(t){var i,s,r,u,d,l,g,p,y,c;let e=(r=(s=(i=t.attachments)!=null?i:t.children)!=null?s:t.items)!=null?r:[];if(!Array.isArray(e))return null;for(let m of e){let w=(l=(u=m.contentType)!=null?u:m.mimeType)!=null?l:(d=m.data)==null?void 0:d.contentType;if(this.isPdfAttachment(w))return(c=(y=(g=m.key)!=null?g:m.attachmentKey)!=null?y:(p=m.data)==null?void 0:p.key)!=null?c:null}return null}isPdfAttachment(t){return t==="application/pdf"}async fetchZoteroChildren(t){var s;let e=this.buildZoteroUrl(`/users/${this.settings.zoteroUserId}/items/${t}/children`);return(s=(await(0,n.requestUrl)({url:e,method:"GET",headers:this.zoteroHeaders()})).json)!=null?s:[]}async downloadZoteroPdf(t){let i={url:this.buildZoteroUrl(`/users/${this.settings.zoteroUserId}/items/${t}/file`),method:"GET",headers:this.zoteroHeaders(),responseType:"arraybuffer"};return(await(0,n.requestUrl)(i)).arrayBuffer}buildZoteroUrl(t){return`${this.settings.zoteroBaseUrl.replace(/\/$/,"")}${t}`}zoteroHeaders(){return this.settings.zoteroApiKey?{"Zotero-API-Key":this.settings.zoteroApiKey}:{}}async ensureFolder(t){let e=this.app.vault.adapter,i=(0,n.normalizePath)(t).split("/").filter(Boolean),s="";for(let r of i)s=s?`${s}/${r}`:r,await e.exists(s)||await e.mkdir(s)}buildNoteMarkdown(t,e,i,s,r){let d=(typeof t.title=="string"?t.title:"").replace(/"/g,"'"),l=`[[${i}]]`,g=`[[${s}]]`;return`---
doc_id: "${e}"
title: "${d}"
---

PDF: ${l}

Item JSON: ${g}

${r}`}getVaultBasePath(){var i;let t=this.app.vault.adapter;if(t instanceof n.FileSystemAdapter)return t.getBasePath();let e=(i=t.getBasePath)==null?void 0:i.call(t);if(e)return e;throw new Error("Vault base path is unavailable.")}getPluginDir(){var i;let t=this.getVaultBasePath(),e=(i=this.manifest.dir)!=null?i:this.manifest.id;if(!e)throw new Error("Plugin directory is unavailable.");return(0,n.normalizePath)(f.default.join(t,e))}getAbsoluteVaultPath(t){let e=this.getVaultBasePath();return(0,n.normalizePath)(f.default.join(e,t))}runPython(t,e){return new Promise((i,s)=>{let r=(0,S.spawn)(this.settings.pythonPath,[t,...e],{cwd:f.default.dirname(t)}),u="";r.stderr.on("data",d=>{u+=d.toString()}),r.on("close",d=>{d===0?i():s(new Error(u||`Process exited with code ${d}`))})})}runPythonWithOutput(t,e){return new Promise((i,s)=>{let r=(0,S.spawn)(this.settings.pythonPath,[t,...e],{cwd:f.default.dirname(t)}),u="",d="";r.stdout.on("data",l=>{u+=l.toString()}),r.stderr.on("data",l=>{d+=l.toString()}),r.on("close",l=>{l===0?i(u.trim()):s(new Error(d||`Process exited with code ${l}`))})})}};
