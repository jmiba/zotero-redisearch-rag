"use strict";var V=Object.create;var b=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var F=(h,t)=>{for(var e in t)b(h,e,{get:t[e],enumerable:!0})},L=(h,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of R(t))!M.call(h,i)&&i!==e&&b(h,i,{get:()=>t[i],enumerable:!(s=E(t,i))||s.enumerable});return h};var A=(h,t,e)=>(e=h!=null?V(B(h)):{},L(t||!h||!h.__esModule?b(e,"default",{value:h,enumerable:!0}):e,h)),z=h=>L(b({},"__esModule",{value:!0}),h);var O={};F(O,{default:()=>S});module.exports=z(O);var a=require("obsidian"),k=require("child_process"),T=require("fs"),N=A(require("http")),$=A(require("https")),p=A(require("path")),P=require("url");var d=require("obsidian"),U={zoteroBaseUrl:"http://127.0.0.1:23119/api",zoteroUserId:"0",pythonPath:"python3",copyPdfToVault:!0,outputPdfDir:"zotero/pdfs",outputItemDir:"zotero/items",outputNoteDir:"zotero/notes",outputChunkDir:"zotero/chunks",redisUrl:"redis://127.0.0.1:6379",redisIndex:"idx:zotero",redisPrefix:"zotero:chunk:",embedBaseUrl:"http://localhost:1234/v1",embedApiKey:"lm-studio",embedModel:"google/embedding-gemma-300m",chatBaseUrl:"",chatApiKey:"",chatModel:"meta-llama/llama-3.1-405b-instruct",chatTemperature:.2,ocrMode:"auto",chunkingMode:"page"},v=class extends d.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Zotero RAG Settings"}),new d.Setting(t).setName("Zotero base URL").setDesc("Local Zotero API base URL, e.g. http://127.0.0.1:23119/api").addText(e=>e.setPlaceholder("http://127.0.0.1:23119/api").setValue(this.plugin.settings.zoteroBaseUrl).onChange(async s=>{this.plugin.settings.zoteroBaseUrl=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Zotero user ID").setDesc("Use 0 for local library. You can also enter users/<id> or groups/<id>.").addText(e=>e.setPlaceholder("123456").setValue(this.plugin.settings.zoteroUserId).onChange(async s=>{this.plugin.settings.zoteroUserId=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Python path").setDesc("Path to python3").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async s=>{this.plugin.settings.pythonPath=s.trim()||"python3",await this.plugin.saveSettings()})),new d.Setting(t).setName("Copy PDFs into vault").setDesc("Disable to use Zotero storage paths directly.").addToggle(e=>e.setValue(this.plugin.settings.copyPdfToVault).onChange(async s=>{this.plugin.settings.copyPdfToVault=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Output folders (vault-relative)"}),new d.Setting(t).setName("PDF folder").addText(e=>e.setPlaceholder("zotero/pdfs").setValue(this.plugin.settings.outputPdfDir).onChange(async s=>{this.plugin.settings.outputPdfDir=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Item JSON folder").addText(e=>e.setPlaceholder("zotero/items").setValue(this.plugin.settings.outputItemDir).onChange(async s=>{this.plugin.settings.outputItemDir=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Notes folder").addText(e=>e.setPlaceholder("zotero/notes").setValue(this.plugin.settings.outputNoteDir).onChange(async s=>{this.plugin.settings.outputNoteDir=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Chunks JSON folder").addText(e=>e.setPlaceholder("zotero/chunks").setValue(this.plugin.settings.outputChunkDir).onChange(async s=>{this.plugin.settings.outputChunkDir=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Redis Stack"}),new d.Setting(t).setName("Redis URL").addText(e=>e.setPlaceholder("redis://127.0.0.1:6379").setValue(this.plugin.settings.redisUrl).onChange(async s=>{this.plugin.settings.redisUrl=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Index name").addText(e=>e.setPlaceholder("idx:zotero").setValue(this.plugin.settings.redisIndex).onChange(async s=>{this.plugin.settings.redisIndex=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Key prefix").addText(e=>e.setPlaceholder("zotero:chunk:").setValue(this.plugin.settings.redisPrefix).onChange(async s=>{this.plugin.settings.redisPrefix=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Embeddings (LM Studio)"}),new d.Setting(t).setName("Embeddings base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.embedBaseUrl).onChange(async s=>{this.plugin.settings.embedBaseUrl=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Embeddings API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.embedApiKey).onChange(async s=>{this.plugin.settings.embedApiKey=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Embeddings model").addText(e=>e.setPlaceholder("google/embedding-gemma-300m").setValue(this.plugin.settings.embedModel).onChange(async s=>{this.plugin.settings.embedModel=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Chat LLM"}),new d.Setting(t).setName("Chat base URL").setDesc("OpenAI-compatible chat endpoint base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.chatBaseUrl).onChange(async s=>{this.plugin.settings.chatBaseUrl=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Chat API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.chatApiKey).onChange(async s=>{this.plugin.settings.chatApiKey=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Chat model").addText(e=>e.setPlaceholder("meta-llama/llama-3.1-405b-instruct").setValue(this.plugin.settings.chatModel).onChange(async s=>{this.plugin.settings.chatModel=s.trim(),await this.plugin.saveSettings()})),new d.Setting(t).setName("Temperature").addText(e=>e.setPlaceholder("0.2").setValue(String(this.plugin.settings.chatTemperature)).onChange(async s=>{let i=Number.parseFloat(s);this.plugin.settings.chatTemperature=Number.isFinite(i)?i:.2,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Docling"}),new d.Setting(t).setName("OCR mode").setDesc("auto, force, or off").addDropdown(e=>e.addOption("auto","auto").addOption("force","force").addOption("off","off").setValue(this.plugin.settings.ocrMode).onChange(async s=>{this.plugin.settings.ocrMode=s,await this.plugin.saveSettings()})),new d.Setting(t).setName("Chunking").setDesc("page or section").addDropdown(e=>e.addOption("page","page").addOption("section","section").setValue(this.plugin.settings.chunkingMode).onChange(async s=>{this.plugin.settings.chunkingMode=s,await this.plugin.saveSettings()}))}};var Z=class extends a.Modal{constructor(t,e,s,i){super(t),this.titleText=e,this.placeholder=s,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.focus();let s=t.createEl("button",{text:"Submit"});s.style.marginTop="0.75rem";let i=()=>{let r=e.value.trim();if(!r){new a.Notice("Query cannot be empty.");return}this.close(),this.onSubmit(r)};s.addEventListener("click",i),e.addEventListener("keydown",r=>{r.key==="Enter"&&i()})}},C=class extends a.Modal{constructor(t,e,s){super(t),this.titleText=e,this.bodyText=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText}),t.createEl("pre").setText(this.bodyText)}},S=class extends a.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new v(this.app,this)),this.addCommand({id:"import-zotero-item-index",name:"Import Zotero item and index (Docling -> RedisSearch)",callback:()=>this.importZoteroItem()}),this.addCommand({id:"ask-zotero-library",name:"Ask my Zotero library (RAG via RedisSearch)",callback:()=>this.askZoteroLibrary()})}async loadSettings(){this.settings=Object.assign({},U,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async importZoteroItem(){var y;let t;try{t=await this.promptZoteroItem()}catch(u){new a.Notice("Zotero search failed. See console for details."),console.error(u);return}if(!t){new a.Notice("No Zotero item selected.");return}let e=(y=t.data)!=null?y:t;!e.key&&t.key&&(e.key=t.key);let s=this.getDocId(e);if(!s){new a.Notice("Could not resolve a stable doc_id from Zotero item.");return}let i=await this.resolvePdfAttachment(e,s);if(!i){new a.Notice("No PDF attachment found for item.");return}let r=(0,a.normalizePath)(`${this.settings.outputPdfDir}/${s}.pdf`),o=(0,a.normalizePath)(`${this.settings.outputItemDir}/${s}.json`),n=(0,a.normalizePath)(`${this.settings.outputChunkDir}/${s}.json`),l=(0,a.normalizePath)(`${this.settings.outputNoteDir}/${s}.md`);try{await this.ensureFolder(this.settings.outputItemDir),await this.ensureFolder(this.settings.outputChunkDir),await this.ensureFolder(this.settings.outputNoteDir),this.settings.copyPdfToVault&&await this.ensureFolder(this.settings.outputPdfDir)}catch(u){new a.Notice("Failed to create output folders."),console.error(u);return}let c="",g="";try{if(this.settings.copyPdfToVault){let u=i.filePath?await T.promises.readFile(i.filePath):await this.downloadZoteroPdf(i.key);await this.app.vault.adapter.writeBinary(r,this.bufferToArrayBuffer(u)),c=this.getAbsoluteVaultPath(r),g=`[[${r}]]`}else{if(!i.filePath){new a.Notice("PDF file path missing. Enable PDF copying or check Zotero storage.");return}c=i.filePath,g=`[PDF](${(0,P.pathToFileURL)(i.filePath).toString()})`}}catch(u){new a.Notice("Failed to download PDF attachment."),console.error(u);return}try{await this.app.vault.adapter.write(o,JSON.stringify(t,null,2))}catch(u){new a.Notice("Failed to write Zotero item JSON."),console.error(u);return}let f=this.getPluginDir(),m=p.default.join(f,"tools","docling_extract.py"),x=p.default.join(f,"tools","index_redisearch.py");try{await this.runPython(m,["--pdf",c,"--doc-id",s,"--out-json",this.getAbsoluteVaultPath(n),"--out-md",this.getAbsoluteVaultPath(l),"--chunking",this.settings.chunkingMode,"--ocr",this.settings.ocrMode])}catch(u){new a.Notice("Docling extraction failed. See console for details."),console.error(u);return}try{await this.runPython(x,["--chunks-json",this.getAbsoluteVaultPath(n),"--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel])}catch(u){new a.Notice("RedisSearch indexing failed. See console for details."),console.error(u);return}try{let u=await this.app.vault.adapter.read(l),w=this.buildNoteMarkdown(e,s,g,o,u);await this.app.vault.adapter.write(l,w)}catch(u){new a.Notice("Failed to finalize note markdown."),console.error(u);return}new a.Notice(`Indexed Zotero item ${s}.`)}async askZoteroLibrary(){if(!this.settings.chatBaseUrl){new a.Notice("Chat base URL must be set in settings.");return}new Z(this.app,"Ask Zotero Library","Enter your query",async t=>{var g,f;let e=this.getPluginDir(),s=p.default.join(e,"tools","rag_query_redisearch.py"),i="";try{i=await this.runPythonWithOutput(s,["--query",t,"--k","5","--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel,"--chat-base-url",this.settings.chatBaseUrl,"--chat-api-key",this.settings.chatApiKey,"--chat-model",this.settings.chatModel,"--temperature",String(this.settings.chatTemperature)])}catch(m){new a.Notice("RAG query failed. See console for details."),console.error(m);return}let r;try{r=JSON.parse(i)}catch(m){new a.Notice("Failed to parse RAG response."),console.error(m);return}let o=(g=r==null?void 0:r.answer)!=null?g:"",l=((f=r==null?void 0:r.citations)!=null?f:[]).map(m=>{var y,u,w,I;let x=(w=m.pages)!=null?w:`${(y=m.page_start)!=null?y:"?"}-${(u=m.page_end)!=null?u:"?"}`;return`${(I=m.doc_id)!=null?I:"?"} pages ${x}`}).join(`
`),c=`${o}

Citations:
${l||"(none)"}`;new C(this.app,"Zotero RAG Answer",c).open()}).open()}async promptZoteroItem(){return new Promise(t=>{new D(this.app,this,t).open()})}getDocId(t){let e=[t.key,t.itemKey,t.id,t.citationKey];for(let s of e)if(typeof s=="string"&&s.trim())return s.trim();return null}async searchZoteroItems(t){let e=new URLSearchParams;e.set("itemType","-attachment"),e.set("limit","25"),e.set("include","data,meta"),t.trim()&&e.set("q",t.trim());let s=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items?${e.toString()}`),i=await this.requestLocalApi(s),r=JSON.parse(i.toString("utf8"));return Array.isArray(r)?r.map(o=>{var n,l,c,g;return{key:(l=o.key)!=null?l:(n=o.data)==null?void 0:n.key,data:(c=o.data)!=null?c:{},meta:(g=o.meta)!=null?g:{}}}).filter(o=>typeof o.key=="string"&&o.key.trim().length>0):[]}async resolvePdfAttachment(t,e){let s=this.pickPdfAttachment(t);if(s)return s;try{let i=await this.fetchZoteroChildren(e);for(let r of i){let o=this.toPdfAttachment(r);if(o)return o}}catch(i){console.error("Failed to fetch Zotero children",i)}return null}pickPdfAttachment(t){var s,i,r;let e=(r=(i=(s=t.attachments)!=null?s:t.children)!=null?i:t.items)!=null?r:[];if(!Array.isArray(e))return null;for(let o of e){let n=this.toPdfAttachment(o);if(n)return n}return null}toPdfAttachment(t){var r,o,n,l,c,g;if(((n=(r=t==null?void 0:t.contentType)!=null?r:t==null?void 0:t.mimeType)!=null?n:(o=t==null?void 0:t.data)==null?void 0:o.contentType)!=="application/pdf")return null;let s=(g=(l=t==null?void 0:t.key)!=null?l:t==null?void 0:t.attachmentKey)!=null?g:(c=t==null?void 0:t.data)==null?void 0:c.key;if(!s)return null;let i=this.extractAttachmentPath(t);return i?{key:s,filePath:i}:{key:s}}extractAttachmentPath(t){var s,i,r,o,n,l,c,g;let e=(g=(o=(i=(s=t==null?void 0:t.links)==null?void 0:s.enclosure)==null?void 0:i.href)!=null?o:(r=t==null?void 0:t.enclosure)==null?void 0:r.href)!=null?g:(c=(l=(n=t==null?void 0:t.data)==null?void 0:n.links)==null?void 0:l.enclosure)==null?void 0:c.href;if(typeof e=="string"&&e.startsWith("file://"))try{return(0,P.fileURLToPath)(e)}catch(f){return null}return null}async fetchZoteroChildren(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/children`),s=await this.requestLocalApi(e);return JSON.parse(s.toString("utf8"))}async downloadZoteroPdf(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/file`),s=await this.requestLocalApiRaw(e),i=await this.followFileRedirect(s);if(i)return i;if(s.statusCode>=300)throw new Error(`Request failed, status ${s.statusCode}`);return s.body}buildZoteroUrl(t){return`${this.settings.zoteroBaseUrl.replace(/\/$/,"")}${t}`}requestLocalApiRaw(t){return new Promise((e,s)=>{let i=new URL(t),o=(i.protocol==="https:"?$.default:N.default).request({method:"GET",hostname:i.hostname,port:i.port||void 0,path:`${i.pathname}${i.search}`,headers:{Accept:"*/*"}},n=>{let l=[];n.on("data",c=>l.push(Buffer.from(c))),n.on("end",()=>{var g;let c=Buffer.concat(l);e({statusCode:(g=n.statusCode)!=null?g:0,headers:n.headers,body:c})})});o.on("error",s),o.end()})}async requestLocalApi(t){let e=await this.requestLocalApiRaw(t);if(e.statusCode>=400)throw new Error(`Request failed, status ${e.statusCode}: ${e.body.toString("utf8")}`);if(e.statusCode>=300)throw new Error(`Request failed, status ${e.statusCode}`);return e.body}async followFileRedirect(t){if(t.statusCode<300||t.statusCode>=400)return null;let e=t.headers.location,s=Array.isArray(e)?e[0]:e;if(!s||typeof s!="string")return null;if(s.startsWith("file://")){let i=(0,P.fileURLToPath)(s);return T.promises.readFile(i)}return s.startsWith("http://")||s.startsWith("https://")?this.requestLocalApi(s):null}bufferToArrayBuffer(t){return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}getZoteroLibraryPath(){let t=(this.settings.zoteroUserId||"0").trim();return!t||t==="0"?"users/0":t.startsWith("users/")||t.startsWith("groups/")?t:`users/${t}`}async ensureFolder(t){let e=this.app.vault.adapter,s=(0,a.normalizePath)(t).split("/").filter(Boolean),i="";for(let r of s)i=i?`${i}/${r}`:r,await e.exists(i)||await e.mkdir(i)}buildNoteMarkdown(t,e,s,i,r){let n=(typeof t.title=="string"?t.title:"").replace(/"/g,"'"),l=`[[${i}]]`;return`---
doc_id: "${e}"
title: "${n}"
---

PDF: ${s}

Item JSON: ${l}

${r}`}getVaultBasePath(){var s;let t=this.app.vault.adapter;if(t instanceof a.FileSystemAdapter)return t.getBasePath();let e=(s=t.getBasePath)==null?void 0:s.call(t);if(e)return e;throw new Error("Vault base path is unavailable.")}getPluginDir(){var i;let t=this.getVaultBasePath(),e=(i=this.manifest.dir)!=null?i:this.manifest.id;if(!e)throw new Error("Plugin directory is unavailable.");let s=p.default.isAbsolute(e)?e:p.default.join(t,e);return p.default.normalize(s)}getAbsoluteVaultPath(t){let e=this.getVaultBasePath(),s=p.default.isAbsolute(t)?t:p.default.join(e,t);return p.default.normalize(s)}runPython(t,e){return new Promise((s,i)=>{let r=(0,k.spawn)(this.settings.pythonPath,[t,...e],{cwd:p.default.dirname(t)}),o="";r.stderr.on("data",n=>{o+=n.toString()}),r.on("close",n=>{n===0?s():i(new Error(o||`Process exited with code ${n}`))})})}runPythonWithOutput(t,e){return new Promise((s,i)=>{let r=(0,k.spawn)(this.settings.pythonPath,[t,...e],{cwd:p.default.dirname(t)}),o="",n="";r.stdout.on("data",l=>{o+=l.toString()}),r.stderr.on("data",l=>{n+=l.toString()}),r.on("close",l=>{l===0?s(o.trim()):i(new Error(n||`Process exited with code ${l}`))})})}},D=class extends a.SuggestModal{constructor(e,s,i){super(e);this.didSelect=!1;this.plugin=s,this.onSelect=i,this.setPlaceholder("Search Zotero items...")}async getSuggestions(e){try{return await this.plugin.searchZoteroItems(e)}catch(s){return console.error("Zotero search failed",s),[]}}renderSuggestion(e,s){var o,n;let i=(n=(o=e.data)==null?void 0:o.title)!=null?n:"[No title]",r=this.extractYear(e);s.createEl("div",{text:i}),s.createEl("small",{text:r?`${r}`:""})}onChooseSuggestion(e,s){this.didSelect=!0,this.onSelect(e)}onClose(){this.didSelect||this.onSelect(null)}extractYear(e){var r,o,n,l;let s=(l=(n=(r=e.meta)==null?void 0:r.parsedDate)!=null?n:(o=e.data)==null?void 0:o.date)!=null?l:"";if(typeof s!="string")return"";let i=s.match(/\b(\d{4})\b/);return i?i[1]:""}};
