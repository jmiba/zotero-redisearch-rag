"use strict";var R=Object.create;var x=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var z=Object.getOwnPropertyNames;var F=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var O=(g,t)=>{for(var e in t)x(g,e,{get:t[e],enumerable:!0})},U=(g,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of z(t))!M.call(g,i)&&i!==e&&x(g,i,{get:()=>t[i],enumerable:!(s=_(t,i))||s.enumerable});return g};var D=(g,t,e)=>(e=g!=null?R(F(g)):{},U(t||!g||!g.__esModule?x(e,"default",{value:g,enumerable:!0}):e,g)),j=g=>U(x({},"__esModule",{value:!0}),g);var q={};O(q,{default:()=>A});module.exports=j(q);var l=require("obsidian"),C=require("child_process"),$=require("fs"),E=D(require("http")),B=D(require("https")),m=D(require("path")),k=require("url");var u=require("obsidian"),V={zoteroBaseUrl:"http://127.0.0.1:23119/api",zoteroUserId:"0",pythonPath:"python3",copyPdfToVault:!0,frontmatterTemplate:`doc_id: {{doc_id}}
zotero_key: {{zotero_key}}
title: {{title_yaml}}
year: {{year}}
authors:
{{authors_yaml}}
item_type: {{item_type}}
pdf_link: {{pdf_link}}
item_json: {{item_json}}`,outputPdfDir:"zotero/pdfs",outputItemDir:"zotero/items",outputNoteDir:"zotero/notes",outputChunkDir:"zotero/chunks",redisUrl:"redis://127.0.0.1:6379",redisIndex:"idx:zotero",redisPrefix:"zotero:chunk:",embedBaseUrl:"http://localhost:1234/v1",embedApiKey:"lm-studio",embedModel:"google/embedding-gemma-300m",chatBaseUrl:"",chatApiKey:"",chatModel:"meta-llama/llama-3.1-405b-instruct",chatTemperature:.2,ocrMode:"auto",chunkingMode:"page"},T=class extends u.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Zotero RAG Settings"}),new u.Setting(t).setName("Zotero base URL").setDesc("Local Zotero API base URL, e.g. http://127.0.0.1:23119/api").addText(e=>e.setPlaceholder("http://127.0.0.1:23119/api").setValue(this.plugin.settings.zoteroBaseUrl).onChange(async s=>{this.plugin.settings.zoteroBaseUrl=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Zotero user ID").setDesc("Use 0 for local library. You can also enter users/<id> or groups/<id>.").addText(e=>e.setPlaceholder("123456").setValue(this.plugin.settings.zoteroUserId).onChange(async s=>{this.plugin.settings.zoteroUserId=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Python path").setDesc("Path to python3").addText(e=>e.setPlaceholder("python3").setValue(this.plugin.settings.pythonPath).onChange(async s=>{this.plugin.settings.pythonPath=s.trim()||"python3",await this.plugin.saveSettings()})),new u.Setting(t).setName("Copy PDFs into vault").setDesc("Disable to use Zotero storage paths directly.").addToggle(e=>e.setValue(this.plugin.settings.copyPdfToVault).onChange(async s=>{this.plugin.settings.copyPdfToVault=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Frontmatter template").setDesc("Use {{doc_id}}, {{zotero_key}}, {{title}}, {{title_yaml}}, {{year}}, {{date}}, {{authors}}, {{authors_yaml}}, {{tags}}, {{item_type}}, {{pdf_link}}, {{item_json}}").addTextArea(e=>{e.inputEl.rows=8,e.setValue(this.plugin.settings.frontmatterTemplate).onChange(async s=>{this.plugin.settings.frontmatterTemplate=s,await this.plugin.saveSettings()})}),t.createEl("h3",{text:"Output folders (vault-relative)"}),new u.Setting(t).setName("PDF folder").addText(e=>e.setPlaceholder("zotero/pdfs").setValue(this.plugin.settings.outputPdfDir).onChange(async s=>{this.plugin.settings.outputPdfDir=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Item JSON folder").addText(e=>e.setPlaceholder("zotero/items").setValue(this.plugin.settings.outputItemDir).onChange(async s=>{this.plugin.settings.outputItemDir=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Notes folder").addText(e=>e.setPlaceholder("zotero/notes").setValue(this.plugin.settings.outputNoteDir).onChange(async s=>{this.plugin.settings.outputNoteDir=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Chunks JSON folder").addText(e=>e.setPlaceholder("zotero/chunks").setValue(this.plugin.settings.outputChunkDir).onChange(async s=>{this.plugin.settings.outputChunkDir=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Redis Stack"}),new u.Setting(t).setName("Redis URL").addText(e=>e.setPlaceholder("redis://127.0.0.1:6379").setValue(this.plugin.settings.redisUrl).onChange(async s=>{this.plugin.settings.redisUrl=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Index name").addText(e=>e.setPlaceholder("idx:zotero").setValue(this.plugin.settings.redisIndex).onChange(async s=>{this.plugin.settings.redisIndex=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Key prefix").addText(e=>e.setPlaceholder("zotero:chunk:").setValue(this.plugin.settings.redisPrefix).onChange(async s=>{this.plugin.settings.redisPrefix=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Embeddings (LM Studio)"}),new u.Setting(t).setName("Embeddings base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.embedBaseUrl).onChange(async s=>{this.plugin.settings.embedBaseUrl=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Embeddings API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.embedApiKey).onChange(async s=>{this.plugin.settings.embedApiKey=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Embeddings model").addText(e=>e.setPlaceholder("google/embedding-gemma-300m").setValue(this.plugin.settings.embedModel).onChange(async s=>{this.plugin.settings.embedModel=s.trim(),await this.plugin.saveSettings()})),t.createEl("h3",{text:"Chat LLM"}),new u.Setting(t).setName("Chat base URL").setDesc("OpenAI-compatible chat endpoint base URL").addText(e=>e.setPlaceholder("http://localhost:1234/v1").setValue(this.plugin.settings.chatBaseUrl).onChange(async s=>{this.plugin.settings.chatBaseUrl=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Chat API key").addText(e=>e.setPlaceholder("lm-studio").setValue(this.plugin.settings.chatApiKey).onChange(async s=>{this.plugin.settings.chatApiKey=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Chat model").addText(e=>e.setPlaceholder("meta-llama/llama-3.1-405b-instruct").setValue(this.plugin.settings.chatModel).onChange(async s=>{this.plugin.settings.chatModel=s.trim(),await this.plugin.saveSettings()})),new u.Setting(t).setName("Temperature").addText(e=>e.setPlaceholder("0.2").setValue(String(this.plugin.settings.chatTemperature)).onChange(async s=>{let i=Number.parseFloat(s);this.plugin.settings.chatTemperature=Number.isFinite(i)?i:.2,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Docling"}),new u.Setting(t).setName("OCR mode").setDesc("auto, force, or off").addDropdown(e=>e.addOption("auto","auto").addOption("force","force").addOption("off","off").setValue(this.plugin.settings.ocrMode).onChange(async s=>{this.plugin.settings.ocrMode=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Chunking").setDesc("page or section").addDropdown(e=>e.addOption("page","page").addOption("section","section").setValue(this.plugin.settings.chunkingMode).onChange(async s=>{this.plugin.settings.chunkingMode=s,await this.plugin.saveSettings()}))}};var I=class extends l.Modal{constructor(t,e,s,i){super(t),this.titleText=e,this.placeholder=s,this.onSubmit=i}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText});let e=t.createEl("input",{type:"text",placeholder:this.placeholder});e.style.width="100%",e.focus();let s=t.createEl("button",{text:"Submit"});s.style.marginTop="0.75rem";let i=()=>{let r=e.value.trim();if(!r){new l.Notice("Query cannot be empty.");return}this.close(),this.onSubmit(r)};s.addEventListener("click",i),e.addEventListener("keydown",r=>{r.key==="Enter"&&i()})}},N=class extends l.Modal{constructor(t,e,s){super(t),this.titleText=e,this.bodyText=s}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h3",{text:this.titleText}),t.createEl("pre").setText(this.bodyText)}},A=class extends l.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new T(this.app,this)),this.addCommand({id:"import-zotero-item-index",name:"Import Zotero item and index (Docling -> RedisSearch)",callback:()=>this.importZoteroItem()}),this.addCommand({id:"ask-zotero-library",name:"Ask my Zotero library (RAG via RedisSearch)",callback:()=>this.askZoteroLibrary()})}async loadSettings(){this.settings=Object.assign({},V,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async importZoteroItem(){var b,P;let t;try{t=await this.promptZoteroItem()}catch(d){new l.Notice("Zotero search failed. See console for details."),console.error(d);return}if(!t){new l.Notice("No Zotero item selected.");return}let e=(b=t.data)!=null?b:t;!e.key&&t.key&&(e.key=t.key);let s=this.getDocId(e);if(!s){new l.Notice("Could not resolve a stable doc_id from Zotero item.");return}let i=await this.resolvePdfAttachment(e,s);if(!i){new l.Notice("No PDF attachment found for item.");return}let r=typeof e.title=="string"?e.title:"",n=this.sanitizeFileName(r)||s,o=await this.resolveUniqueBaseName(n,s),a=(0,l.normalizePath)(`${this.settings.outputPdfDir}/${o}.pdf`),c=(0,l.normalizePath)(`${this.settings.outputItemDir}/${s}.json`),h=(0,l.normalizePath)(`${this.settings.outputChunkDir}/${s}.json`),f=(0,l.normalizePath)(`${this.settings.outputNoteDir}/${o}.md`);try{await this.ensureFolder(this.settings.outputItemDir),await this.ensureFolder(this.settings.outputChunkDir),await this.ensureFolder(this.settings.outputNoteDir),this.settings.copyPdfToVault&&await this.ensureFolder(this.settings.outputPdfDir)}catch(d){new l.Notice("Failed to create output folders."),console.error(d);return}let p="",w="";try{if(this.settings.copyPdfToVault){let d=i.filePath?await $.promises.readFile(i.filePath):await this.downloadZoteroPdf(i.key);await this.app.vault.adapter.writeBinary(a,this.bufferToArrayBuffer(d)),p=this.getAbsoluteVaultPath(a),w=`[[${a}]]`}else{if(!i.filePath){new l.Notice("PDF file path missing. Enable PDF copying or check Zotero storage.");return}p=i.filePath,w=`[PDF](${(0,k.pathToFileURL)(i.filePath).toString()})`}}catch(d){new l.Notice("Failed to download PDF attachment."),console.error(d);return}try{await this.app.vault.adapter.write(c,JSON.stringify(t,null,2))}catch(d){new l.Notice("Failed to write Zotero item JSON."),console.error(d);return}let y=this.getPluginDir(),v=m.default.join(y,"tools","docling_extract.py"),S=m.default.join(y,"tools","index_redisearch.py");try{await this.runPython(v,["--pdf",p,"--doc-id",s,"--out-json",this.getAbsoluteVaultPath(h),"--out-md",this.getAbsoluteVaultPath(f),"--chunking",this.settings.chunkingMode,"--ocr",this.settings.ocrMode])}catch(d){new l.Notice("Docling extraction failed. See console for details."),console.error(d);return}try{await this.runPython(S,["--chunks-json",this.getAbsoluteVaultPath(h),"--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel])}catch(d){new l.Notice("RedisSearch indexing failed. See console for details."),console.error(d);return}try{let d=await this.app.vault.adapter.read(f),Z=this.buildNoteMarkdown(e,(P=t.meta)!=null?P:{},s,w,c,d);await this.app.vault.adapter.write(f,Z)}catch(d){new l.Notice("Failed to finalize note markdown."),console.error(d);return}new l.Notice(`Indexed Zotero item ${s}.`)}async askZoteroLibrary(){if(!this.settings.chatBaseUrl){new l.Notice("Chat base URL must be set in settings.");return}new I(this.app,"Ask Zotero Library","Enter your query",async t=>{var h,f;let e=this.getPluginDir(),s=m.default.join(e,"tools","rag_query_redisearch.py"),i="";try{i=await this.runPythonWithOutput(s,["--query",t,"--k","5","--redis-url",this.settings.redisUrl,"--index",this.settings.redisIndex,"--prefix",this.settings.redisPrefix,"--embed-base-url",this.settings.embedBaseUrl,"--embed-api-key",this.settings.embedApiKey,"--embed-model",this.settings.embedModel,"--chat-base-url",this.settings.chatBaseUrl,"--chat-api-key",this.settings.chatApiKey,"--chat-model",this.settings.chatModel,"--temperature",String(this.settings.chatTemperature)])}catch(p){new l.Notice("RAG query failed. See console for details."),console.error(p);return}let r;try{r=JSON.parse(i)}catch(p){new l.Notice("Failed to parse RAG response."),console.error(p);return}let n=(h=r==null?void 0:r.answer)!=null?h:"",a=((f=r==null?void 0:r.citations)!=null?f:[]).map(p=>{var y,v,S,b;let w=(S=p.pages)!=null?S:`${(y=p.page_start)!=null?y:"?"}-${(v=p.page_end)!=null?v:"?"}`;return`${(b=p.doc_id)!=null?b:"?"} pages ${w}`}).join(`
`),c=`${n}

Citations:
${a||"(none)"}`;new N(this.app,"Zotero RAG Answer",c).open()}).open()}async promptZoteroItem(){return new Promise(t=>{new L(this.app,this,t).open()})}getDocId(t){let e=[t.key,t.itemKey,t.id,t.citationKey];for(let s of e)if(typeof s=="string"&&s.trim())return s.trim();return null}sanitizeFileName(t){let e=t.replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g," ").trim();return e?e.replace(/[.]+$/g,"").trim().replace(/ /g,"-").slice(0,120):""}async resolveUniqueBaseName(t,e){let s=this.app.vault.adapter,i=(0,l.normalizePath)(`${this.settings.outputNoteDir}/${t}.md`),r=(0,l.normalizePath)(`${this.settings.outputPdfDir}/${t}.pdf`),n=await s.exists(i),o=this.settings.copyPdfToVault?await s.exists(r):!1;return n||o?`${t}-${e}`:t}async searchZoteroItems(t){let e=new URLSearchParams;e.set("itemType","-attachment"),e.set("limit","25"),e.set("include","data,meta"),t.trim()&&e.set("q",t.trim());let s=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items?${e.toString()}`),i=await this.requestLocalApi(s,`Zotero search failed for ${s}`),r=JSON.parse(i.toString("utf8"));return Array.isArray(r)?r.map(n=>{var o,a,c,h;return{key:(a=n.key)!=null?a:(o=n.data)==null?void 0:o.key,data:(c=n.data)!=null?c:{},meta:(h=n.meta)!=null?h:{}}}).filter(n=>typeof n.key=="string"&&n.key.trim().length>0):[]}async resolvePdfAttachment(t,e){let s=this.pickPdfAttachment(t);if(s)return s;try{let i=await this.fetchZoteroChildren(e);for(let r of i){let n=this.toPdfAttachment(r);if(n)return n}}catch(i){console.error("Failed to fetch Zotero children",i)}return null}pickPdfAttachment(t){var s,i,r;let e=(r=(i=(s=t.attachments)!=null?s:t.children)!=null?i:t.items)!=null?r:[];if(!Array.isArray(e))return null;for(let n of e){let o=this.toPdfAttachment(n);if(o)return o}return null}toPdfAttachment(t){var r,n,o,a,c,h;if(((o=(r=t==null?void 0:t.contentType)!=null?r:t==null?void 0:t.mimeType)!=null?o:(n=t==null?void 0:t.data)==null?void 0:n.contentType)!=="application/pdf")return null;let s=(h=(a=t==null?void 0:t.key)!=null?a:t==null?void 0:t.attachmentKey)!=null?h:(c=t==null?void 0:t.data)==null?void 0:c.key;if(!s)return null;let i=this.extractAttachmentPath(t);return i?{key:s,filePath:i}:{key:s}}extractAttachmentPath(t){var s,i,r,n,o,a,c,h;let e=(h=(n=(i=(s=t==null?void 0:t.links)==null?void 0:s.enclosure)==null?void 0:i.href)!=null?n:(r=t==null?void 0:t.enclosure)==null?void 0:r.href)!=null?h:(c=(a=(o=t==null?void 0:t.data)==null?void 0:o.links)==null?void 0:a.enclosure)==null?void 0:c.href;if(typeof e=="string"&&e.startsWith("file://"))try{return(0,k.fileURLToPath)(e)}catch(f){return null}return null}async fetchZoteroChildren(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/children`),s=await this.requestLocalApi(e,`Zotero children request failed for ${e}`);return JSON.parse(s.toString("utf8"))}async downloadZoteroPdf(t){let e=this.buildZoteroUrl(`/${this.getZoteroLibraryPath()}/items/${t}/file`),s=await this.requestLocalApiRaw(e),i=await this.followFileRedirect(s);if(i)return i;if(s.statusCode>=300)throw new Error(`Request failed, status ${s.statusCode}`);return s.body}buildZoteroUrl(t){return`${this.settings.zoteroBaseUrl.replace(/\/$/,"")}${t}`}requestLocalApiRaw(t){return new Promise((e,s)=>{let i=new URL(t),n=(i.protocol==="https:"?B.default:E.default).request({method:"GET",hostname:i.hostname,port:i.port||void 0,path:`${i.pathname}${i.search}`,headers:{Accept:"*/*"}},o=>{let a=[];o.on("data",c=>a.push(Buffer.from(c))),o.on("end",()=>{var h;let c=Buffer.concat(a);e({statusCode:(h=o.statusCode)!=null?h:0,headers:o.headers,body:c})})});n.on("error",s),n.end()})}async requestLocalApi(t,e){let s=await this.requestLocalApiRaw(t);if(s.statusCode>=400){let i=s.body.toString("utf8");throw new Error(`${e!=null?e:"Request failed"}, status ${s.statusCode}: ${i||"no response body"}`)}if(s.statusCode>=300)throw new Error(`${e!=null?e:"Request failed"}, status ${s.statusCode}`);return s.body}async followFileRedirect(t){if(t.statusCode<300||t.statusCode>=400)return null;let e=t.headers.location,s=Array.isArray(e)?e[0]:e;if(!s||typeof s!="string")return null;if(s.startsWith("file://")){let i=(0,k.fileURLToPath)(s);return $.promises.readFile(i)}return s.startsWith("http://")||s.startsWith("https://")?this.requestLocalApi(s):null}bufferToArrayBuffer(t){return t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}getZoteroLibraryPath(){let t=(this.settings.zoteroUserId||"0").trim();return!t||t==="0"?"users/0":t.startsWith("users/")||t.startsWith("groups/")?t:`users/${t}`}async ensureFolder(t){let e=this.app.vault.adapter,s=(0,l.normalizePath)(t).split("/").filter(Boolean),i="";for(let r of s)i=i?`${i}/${r}`:r,await e.exists(i)||await e.mkdir(i)}buildNoteMarkdown(t,e,s,i,r,n){let o=`[[${r}]]`,a=this.renderFrontmatter(t,e,s,i,o);return`${a?`---
${a}
---

`:""}PDF: ${i}

Item JSON: ${o}

${n}`}renderFrontmatter(t,e,s,i,r){var a;let n=(a=this.settings.frontmatterTemplate)!=null?a:"";if(!n.trim())return"";let o=this.buildTemplateVars(t,e,s,i,r);return n.replace(/{{\s*([a-z0-9_]+)\s*}}/gi,(c,h)=>{var f;return(f=o[h])!=null?f:""}).trim()}buildTemplateVars(t,e,s,i,r){let n=typeof t.title=="string"?t.title:"",o=typeof t.shortTitle=="string"?t.shortTitle:"",a=typeof t.date=="string"?t.date:"",c=typeof(e==null?void 0:e.parsedDate)=="string"?e.parsedDate:"",h=this.extractYear(c||a),p=(Array.isArray(t.creators)?t.creators:[]).filter(d=>d.creatorType==="author").map(d=>this.formatCreatorName(d)),w=p.join("; "),y=Array.isArray(t.tags)?t.tags.map(d=>typeof d=="string"?d:d==null?void 0:d.tag).filter(Boolean):[],v=y.join("; "),S=typeof t.itemType=="string"?t.itemType:"",b=typeof(e==null?void 0:e.creatorSummary)=="string"?e.creatorSummary:"",P={doc_id:s,zotero_key:typeof t.key=="string"?t.key:s,title:n,short_title:o,date:a,year:h,authors:w,tags:v,item_type:S,creator_summary:b,pdf_link:this.escapeYamlString(i),item_json:this.escapeYamlString(r)};for(let[d,Z]of Object.entries(P))P[`${d}_yaml`]=this.escapeYamlString(Z);return P.authors_yaml=this.toYamlList(p),P.tags_yaml=this.toYamlList(y),P}extractYear(t){if(!t)return"";let e=t.match(/\b(\d{4})\b/);return e?e[1]:""}formatCreatorName(t){if(!t||typeof t!="object")return"";if(t.name)return String(t.name);let e=t.firstName?String(t.firstName):"",s=t.lastName?String(t.lastName):"";return[s,e].filter(Boolean).join(", ")||`${e} ${s}`.trim()}escapeYamlString(t){return`"${String(t).replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}toYamlList(t){return t.length?t.map(e=>`  - ${this.escapeYamlString(e)}`).join(`
`):'  - ""'}getVaultBasePath(){var s;let t=this.app.vault.adapter;if(t instanceof l.FileSystemAdapter)return t.getBasePath();let e=(s=t.getBasePath)==null?void 0:s.call(t);if(e)return e;throw new Error("Vault base path is unavailable.")}getPluginDir(){var i;let t=this.getVaultBasePath(),e=(i=this.manifest.dir)!=null?i:this.manifest.id;if(!e)throw new Error("Plugin directory is unavailable.");let s=m.default.isAbsolute(e)?e:m.default.join(t,e);return m.default.normalize(s)}getAbsoluteVaultPath(t){let e=this.getVaultBasePath(),s=m.default.isAbsolute(t)?t:m.default.join(e,t);return m.default.normalize(s)}runPython(t,e){return new Promise((s,i)=>{let r=(0,C.spawn)(this.settings.pythonPath,[t,...e],{cwd:m.default.dirname(t)}),n="";r.stderr.on("data",o=>{n+=o.toString()}),r.on("close",o=>{o===0?s():i(new Error(n||`Process exited with code ${o}`))})})}runPythonWithOutput(t,e){return new Promise((s,i)=>{let r=(0,C.spawn)(this.settings.pythonPath,[t,...e],{cwd:m.default.dirname(t)}),n="",o="";r.stdout.on("data",a=>{n+=a.toString()}),r.stderr.on("data",a=>{o+=a.toString()}),r.on("close",a=>{a===0?s(n.trim()):i(new Error(o||`Process exited with code ${a}`))})})}},L=class extends l.SuggestModal{constructor(e,s,i){super(e);this.lastError=null;this.plugin=s,this.resolveSelection=i,this.setPlaceholder("Search Zotero items...")}async getSuggestions(e){try{return await this.plugin.searchZoteroItems(e)}catch(s){let i=s instanceof Error?s.message:String(s);return this.lastError!==i&&(this.lastError=i,new l.Notice(i)),console.error("Zotero search failed",s),[]}}renderSuggestion(e,s){var n,o;let i=(o=(n=e.data)==null?void 0:n.title)!=null?o:"[No title]",r=this.extractYear(e);s.createEl("div",{text:i}),s.createEl("small",{text:r?`${r}`:""}),s.addEventListener("click",()=>{this.resolveSelection&&(this.resolveSelection(e),this.resolveSelection=null),this.close()})}onChooseSuggestion(e,s){this.resolveSelection&&(this.resolveSelection(e),this.resolveSelection=null),this.close()}onClose(){this.resolveSelection&&(this.resolveSelection(null),this.resolveSelection=null)}extractYear(e){var r,n,o,a;let s=(a=(o=(r=e.meta)==null?void 0:r.parsedDate)!=null?o:(n=e.data)==null?void 0:n.date)!=null?a:"";if(typeof s!="string")return"";let i=s.match(/\b(\d{4})\b/);return i?i[1]:""}};
